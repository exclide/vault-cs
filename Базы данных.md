### Нормальные формы
Нужны для устранения различных аномалий, приводящих к неконсистентности данных

Аномалия модификации - изменения одной записи повлечет за собой просмотр всей таблицы и измнения других записей
Аномалия удаления - при удалении записи может пропасть и другая информация
Аномалия добавления - информацию в таблицу нельзя поместить пока она неполная или требуется дополнительный просмотр таблицы

** Функциональная зависимость ** - Y функционально зависит от X или X функционально определяет Y- когда каждому X соотетствует ровно одно Y. Иначе, если есть строка с X, и есть какая-то другая строка с X, то оба значения Y будут равны. Иначе X единственным образом отображается в Y. (X - детерминант)
** Частичная функц. зависимость ** - зависимость неключевого атрибута от части составного ключа
** Полная функц. ** - неключевой атрибут полностью зависит от всего ключа

1НФ. Все атрибуты являются аторарными, неделимыми
2НФ. Находится в 1НФ и каждый неключевой атрибут функционально полно зависит от первичного ключа
3НФ. Находится в 2НФ и все неключевые атрибуты взаимно независимы и полностью зависят от первичного ключа. Или - ни один неключевой атрибут не находится в транзитивной зависимости от первичного ключа.
БКНФ. Если в 3НФ и детерминанты всех функц. зависимостей являются потенциальными ключами
4НФ. Если в БКНФ и не содержит нетривиальных многозначных зависимостей

### ACID, транзакции
Атомарность - все транзакции едины, результат либо commit либо revert
Консистентность - целостность, непротиворечивость данных в любой момент времени
Изолированность - изоляция конкурентных транзакций (блокировки или версионирование (snapshot))
Durability - если записали что-то, изменения не будут потеряны

### CAP теорема
Consistency - в любой момент времени данные не противоречат друг другу
Availability - любой запрос обязан вернуть ответ (необязательно консистентные)
Partition tolerance - при отказе одного узла, система сохранит работоспособность

### Индексы БД
Индексы - дополнительная структура данных, построенная на каком-либо атрибуте, обычно на первичном ключе

Для чего - хотим быстро искать строки по запросу select... where
Без индексов пришлось линейно проходиться по всем строкам таблицы, для этого загружать сразу все с диска в память либо, если таблица слишком большая, частично - много запросов к диску = медленно.

В большинстве случаев имеет смысл и используется B+ дерево. В каждой ноде такого дерева может быть M ключей, у каждой ноды может быть до M+1 детей. При этом ключи упорядочены в ноде. В листьях дерева хранятся указатели на все строки БД.

**Плотный индекс** - ключи всех элементов
**Разряженный индекс** - ключи части элементов
**Первичный индекс** - индекс по первичному ключу и он же упорядочен
**Кластеризованный индекс** - строки на диске хранятся в порядке индекса. 
**Покрывающий индекс** - в самом индексе есть все нужные столбцы запроса, не нужно ходить по ссылке на строку на диск.

### Побочные эффекты конкурентных транзакций

**Lost update** - когда несколько транзакций что-т-о обновили в БД, но по итогам результат такой, будто отработала лишь часть транзакций. Самый опасный побочный эффект, по сути отсутствие изоляции транзакций.

**Dirty read** - когда транзакция может прочитать данные, которые были добавлены/изменены другой транзакцией, пока та еще не вызвала COMMIT этих данных.

Non-repeatable-read - когда одинаковый запрос в одной транзакции может вернуть разные данные.

Phantom reads - когда одинаковый запрос может вернуть НОВЫЕ строки, которые были закомичены из другой транзакции.

По возрастанию сложности:
**LOST UPDATE < DIRTY READ < NON-REPEATABLE READ < PHANTOM READ**
Чем сложнее побочный эффект, тем сложнее его избежать. Чем сильнее уровень изоляции, тем меньше производительность БД.

### Уровни изоляции транзакций

+--------------------+--------------+--------------------------+------------------+
|  Isolation level        |  Dirty reads  |  Non-repeatable reads  |  Phantom reads  |
|  Read uncommited |      YES         |                 YES                 |            YES          |
|  Read commited     |      NO         |                 YES                 |            YES          |
|  Repeatable read    |      NO         |                 NO                  |            YES          |
|  Serializable            |      NO         |                 NO                  |            NO          |
|  Snapshot               |      NO         |                 NO                  |            NO          |
+--------------------+-------------+---------------------------+------------------+

### Подходы к реализации уровней изоляции

**Версионирвоание (snapshot)** - транзакции будут работать со своей копией данных, но после несколько копий будут слиты в одну.

**Блокирование (lock)** - транзакция будет ждать освобождения лока на строки, таблицы. Медленная.

